<?php
/**
 * Copyright © Magento, Inc. All rights reserved.
 * See COPYING.txt for license details.
 */

// @codingStandardsIgnoreFile

?>
<?php
/**
 * Ship to multiple address template
 *
 * @var $block \Magento\Multishipping\Block\Checkout\Addresses
 */

 
$objectManager = \Magento\Framework\App\ObjectManager::getInstance();
$cart = $objectManager->get('\Magento\Checkout\Model\Cart');
$idQuote=$cart->getQuote()->getId();

echo "<div id='quoteId' style='display: none'>$idQuote</div>";

echo "<div id='homePath' style='display: none'>".$this->getBaseUrl()."</div>";
?>
<div class="wrapper">
    <a class="return-arrow" href="#"></a>
    <p class="heading">Shopping Cart</p>
    <form id="checkout_multishipping_form" action="<?= $block->escapeUrl($block->getPostActionUrl()) ?>" method="post" class="multicheckout address form">
    <input type="hidden" name="continue" value="1" id="can_continue_flag">
    <div>
        <div class="basket-list">
            <div class="head">
                <span>Item</span>
                <span>Price</span>
                <span>Quantity</span>
                <span>Address</span>
                <span>Subtotal</span>
            </div>
            <div id="container-items">
                
            </div>
        </div>
        <div class="panel">
            <div class="summary" id="multiShippingSummary">
                
            </div>
        </div>
    </div>
    <div class="bottom">
        <label class="input-with-button">
            <span>Apply Discount Code</span>
            <input type="text">
            <button class="btn btn-gold btn-rectangle">Apply</button>
        </label>
    </div>
    </form>
</div>

<script>
require(['jquery'], function ($) {
    $(document).on("ready", function(){
        function updateMultiShippingCart() {
            require(["jquery"], function ($) {
                var j = {
                    quoteId: parseInt($("#quoteId").text()),
                };
                j = JSON.stringify(j);
                $.ajax({
                    url: $("#homePath").text() + "/rest/V1/blmCart/getCart/",
                    data: j,
                    type: 'POST',
                    dataType: 'json',
                    cache: false,
                    contentType: 'application/json',
                    processData: false,
                    /** @inheritdoc */
                    success: function (res) {
                        $("#container-items").html('');
                        $("#multiShippingSummary").html('');
                        console.log(JSON.parse(res));
                        var itemsOutput = JSON.parse(res);
                        var output = "";
                        
                        $.each(itemsOutput.data, (index, item) => {
                            var selectAddresses = multiShippingCreateSelect(itemsOutput.addresses,item.address);
                            output += getMultiShippingTemplate(item,selectAddresses);
                        });

                        $("#container-items").append(output);
                        $("#multiShippingSummary").append(getMultiShippingSummary(itemsOutput.TotalData));
                    },

                    /** @inheritdoc */
                    error: function (res) {

                        console.info("error add - multishipping.js");
                    }
                });
            });
        }


        function getMultiShippingTemplate(item,selectAddresses) {
            item.price = parseFloat(item.price).toFixed(2);
            return `<div class="basket-item">
        <div class="img" >
            <img style="max-width: 25%; max-height: 25%;" src="${item.image}" alt="">
        </div>
        <div class="text">
            <p class="name">${item.name}</p>
        </div>
        <div class="price">
            £${item.price}
            <div class="switch">
                <input type="checkbox" ${item.type == 21 ? ' checked="checked"' : ' ""'}>
                <span class="switch-body"></span>
                <span class="icons">
                    <span class="left">
                        <img src="./assets/img/icons/view_1.png" alt="">
                    </span>
                    <span class="right">
                        <img src="./assets/img/icons/view_2.png" alt="">
                    </span>
                </span>
            </div>
        </div>
        <div class="quantity">
            <div class="custom-input-number">
                <input type="number" value="${item.qty}">
                <span class="increment" onClick="multiShippingAddItem(this,1)">+</span>
                <span class="decrement" onClick="multiShippingAddItem(this,2)">-</span>
            </div>
        </div>
        <div>
            <div class="field address">
                <div class="control">
                ${selectAddresses}
                </div>
            </div>
        </div>
        <div class="subtotal">£${item.price * parseFloat(item.qty)}</div>
        <span class="btn-remove"></span>
    </div>`;
        }
        function getMultiShippingSummary(total) {
            var output = `<p class="heading">Summary</p>
        <div class="borders">
        <p>
            <span>Subtotal</span>
            <span>£${total.totalCost}</span>
        </p>
        </div>
            <p class="total">
                <span>Order Total</span>
                <span>£${total.totalCost}</span>
            </p>
        <button class="btn btn-green" type="submit">
            Proceed to checkout
        </button>`;
            return output;

        }

       function multiShippingCreateSelect(addresses,toSelect){
        var output='<select title="">';
            $.each(addresses, (index, item) => {
                output +=`<option ${toSelect==item.entity_id?selected="selected":""} value="${item.entity_id}">${item.city}, ${item.company}, ${item.firstname} ${item.lastname} ,${item.postcode}, ${item.country_id}</option>`;
            });
               
        output+="</select>";

        return output;
       }
        
        
        
        updateMultiShippingCart();
    });
});
    </script>